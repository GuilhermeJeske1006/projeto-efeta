#!/bin/bash
set -e

# -------------------------------
# ConfiguraÃ§Ãµes de ambiente
# -------------------------------
APP_ENV=$(grep APP_ENV .env | cut -d '=' -f2)
NODE_VERSION=20

echo "âœ… Garantindo Node.js v${NODE_VERSION}..."
# Se estiver usando nvm
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

nvm install ${NODE_VERSION}
nvm use ${NODE_VERSION}
echo "Node.js version: $(node -v)"
echo "NPM version: $(npm -v)"

# -------------------------------
# Composer
# -------------------------------
echo "ğŸ“¦ Rodando composer install..."
composer --no-ansi --no-interaction --optimize-autoloader --no-progress --profile --no-cache install

echo "ğŸš€ Rodando migrations para o ambiente ${APP_ENV}..."
php artisan migrate --force

# -------------------------------
# Node / NPM
# -------------------------------
echo "ğŸ§¹ Limpando node_modules e package-lock.json..."
rm -rf node_modules package-lock.json

echo "ğŸ“¥ Instalando dependÃªncias NPM sem pacotes opcionais..."
npm install --no-audit --no-optional --no-progress

echo "ğŸ—ï¸ Rodando build Vite..."
npm run build

echo "âœ… Deploy concluÃ­do!"
